#!/bin/bash

CONF_DIR=configs
CERT_DIR=certs

# create (clean) output directory
rm -rf ${CERT_DIR}
mkdir  ${CERT_DIR}

# create root CA csr & pem
openssl req                      \
    -new -newkey rsa:2048 -noenc \
    -config ${CONF_DIR}/ca.cnf   \
    -keyout ${CERT_DIR}/ca.key   \
    -out    ${CERT_DIR}/ca.csr

openssl x509                    \
    -req -extensions v3_req     \
    -extfile ${CONF_DIR}/ca.cnf \
    -signkey ${CERT_DIR}/ca.key \
    -in      ${CERT_DIR}/ca.csr \
    -out     ${CERT_DIR}/ca.pem

# create root leaf csr & pem
openssl req                      \
    -new -newkey rsa:2048 -noenc \
    -config ${CONF_DIR}/leaf.cnf \
    -keyout ${CERT_DIR}/leaf.key \
    -out    ${CERT_DIR}/leaf.csr

openssl x509                                \
    -req -extensions v3_req -CAcreateserial \
    -CA      ${CERT_DIR}/ca.pem             \
    -CAkey   ${CERT_DIR}/ca.key             \
    -extfile ${CONF_DIR}/leaf.cnf           \
    -in      ${CERT_DIR}/leaf.csr           \
    -out     ${CERT_DIR}/leaf.pem

# clean up useless files
rm -f ${CERT_DIR}/{ca.{csr,key,srl},leaf.csr}

