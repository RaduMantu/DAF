FROM ubuntu:22.04
WORKDIR /root

# need 2x COPY or contents of certs/ will be copied individualy
COPY certs/ /root/certs
COPY startup.sh /root

# overwrite this with `docker build --build-arg ASAN_EN=''`
ARG ASAN_EN='enable-asan'

# compile latest vulnerable version of openssl
RUN apt update                                       \
 && apt upgrade -y                                   \
 && apt install -y git build-essential               \
 && git clone https://github.com/openssl/openssl.git \
 && cd openssl                                       \
 && git checkout openssl-3.0.6                       \
 && ./Configure --prefix=/root/vuln-openssl          \
                ${ASAN_EN}                           \
                '-Wl,-rpath,$(LIBRPATH)'             \
 && make -j $(nproc) build_sw                        \
 && make -j $(nproc) install_sw

# see startup.sh for `docker run` arguments to pass
ENTRYPOINT [ "/root/startup.sh" ]

